<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Active Units Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 4px;
      font-family: system-ui, sans-serif;
      font-size: 13px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    }
    #legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 4px;
      font-family: system-ui, sans-serif;
      font-size: 13px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div id="status">Loading units…</div>
  <div id="map"></div>
  <div id="legend">
    <div class="legend-item">
      <span class="legend-color" style="background: green;"></span> Available / At Post
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background: orange;"></span> En Route
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background: red;"></span> At Scene / Transporting
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background: gray;"></span> Administrative / Maintenance
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Your XML feed URL
    const DATA_URL = "https://vanguard.emsanyware.com/loadVehicles.php?_=1763521620670";

    const statusEl = document.getElementById("status");

    // Rough center over SC
    const map = L.map("map").setView([34.2, -80.5], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    function rgbToCss(rgbStr) {
      // "0,255,0" -> "rgb(0,255,0)"
      if (!rgbStr) return null;
      return "rgb(" + rgbStr + ")";
    }

    function statusColorFromAttrs(colorAttr, vehStatusText) {
      // First, try the explicit color attribute from <title color="r,g,b">
      if (colorAttr) {
        if (colorAttr === "0,255,0") return "green";        // Available / At Post
        if (colorAttr === "225,192,0") return "orange";     // En Route
        if (colorAttr === "255,0,0") return "red";          // At Scene / Transporting
        if (colorAttr === "192,192,192") return "gray";     // Admin / Maintenance
      }

      const s = (vehStatusText || "").toLowerCase();
      if (s.includes("available") || s.includes("at post")) return "green";
      if (s.includes("en route") || s.includes("enr")) return "orange";
      if (s.includes("at scene") || s.includes("transport")) return "red";
      if (s.includes("administrative") || s.includes("maintenance")) return "gray";

      return "blue"; // Fallback
    }

    function getText(el, tagName) {
      const node = el.getElementsByTagName(tagName)[0];
      return node ? node.textContent.trim() : "";
    }

    async function loadUnits() {
      statusEl.textContent = "Loading units…";

      try {
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const xmlText = await res.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");

        const items = Array.from(xmlDoc.getElementsByTagName("item"));
        console.log("Units count:", items.length);

        markersLayer.clearLayers();

        if (!items.
