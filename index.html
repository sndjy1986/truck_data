<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Active Units Map (Debug)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 4px;
      font-family: system-ui, sans-serif;
      font-size: 13px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      max-width: 320px;
      white-space: pre-wrap;
    }
    #legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 4px;
      font-family: system-ui, sans-serif;
      font-size: 13px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div id="status">Loading units…</div>
  <div id="map"></div>
  <div id="legend">
    <div class="legend-item">
      <span class="legend-color" style="background: green;"></span> Available / At Post
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background: orange;"></span> En Route
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background: red;"></span> At Scene / Transporting
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background: gray;"></span> Administrative / Maintenance
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const DATA_URL = "https://vanguard.emsanyware.com/loadVehicles.php?_=1763521620556";
    const statusEl = document.getElementById("status");

    // Show any uncaught JS errors in the status box
    window.addEventListener("error", (e) => {
      console.error("Window error:", e.error || e.message);
      statusEl.textContent = "JS error: " + (e.error?.message || e.message);
    });

    // Basic map, centered over SC
    const map = L.map("map").setView([34.2, -80.5], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    function statusColorFromAttrs(colorAttr, vehStatusText) {
      if (colorAttr) {
        if (colorAttr === "0,255,0") return "green";
        if (colorAttr === "225,192,0") return "orange";
        if (colorAttr === "255,0,0") return "red";
        if (colorAttr === "192,192,192") return "gray";
      }

      const s = (vehStatusText || "").toLowerCase();
      if (s.includes("available") || s.includes("at post")) return "green";
      if (s.includes("en route") || s.includes("enr")) return "orange";
      if (s.includes("at scene") || s.includes("transport")) return "red";
      if (s.includes("administrative") || s.includes("maintenance")) return "gray";

      return "blue";
    }

    function getText(el, tagName) {
      const node = el.getElementsByTagName(tagName)[0];
      return node ? node.textContent.trim() : "";
    }

    async function loadUnits() {
      statusEl.textContent = "Loading units…";

      try {
        console.log("Fetching:", DATA_URL);

        const res = await fetch(DATA_URL, { cache: "no-store" });
        console.log("Response:", res);

        if (!res.ok) {
          throw new Error("HTTP " + res.status + " " + res.statusText);
        }

        const xmlText = await res.text();
        console.log("XML sample:", xmlText.slice(0, 500));

        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");

        // Check for parser error (e.g. if login page HTML comes back instead of XML)
        const parserError = xmlDoc.getElementsByTagName("parsererror")[0];
        if (parserError) {
          const msg = parserError.textContent || "Unknown XML parse error";
          throw new Error("XML parse error: " + msg.slice(0, 200));
        }

        const items = Array.from(xmlDoc.getElementsByTagName("item"));
        console.log("Items found:", items.length);

        markersLayer.clearLayers();

        if (!items.length) {
          statusEl.textContent = "No <item> elements found in feed.";
          return;
        }

        const bounds = [];

        items.forEach((item) => {
          const latLon = getText(item, "LatLon");
          if (!latLon) return;

          const [latStr, lonStr] = latLon.split(",");
          const lat = parseFloat(latStr);
          const lng = parseFloat(lonStr);
          if (Number.isNaN(lat) || Number.isNaN(lng)) return;

          const id = getText(item, "ID");
          const titleEl = item.getElementsByTagName("title")[0];
          const titleText = titleEl ? titleEl.textContent.trim() : "";
          const titleColorAttr = titleEl ? titleEl.getAttribute("color") : null;

          const description = getText(item, "description");
          const companyName = getText(item, "CompanyName");
          const vehStatus = getText(item, "VehStatus");
          const vehicleStatusDetail = getText(item, "VehicleStatus");
          const startDateTime = getText(item, "StartDateTime");

          const markerColor = statusColorFromAttrs(titleColorAttr, vehStatus);

          const marker = L.circleMarker([lat, lng], {
            radius: 7,
            weight: 2,
            color: markerColor,
            fillColor: markerColor,
            fillOpacity: 0.9
          });

          const popupHtml = `
            <strong>${titleText || ("Unit " + id)}</strong><br/>
            ${companyName ? companyName + "<br/>" : ""}
            Status: ${vehStatus || "N/A"}<br/>
            Detail: ${vehicleStatusDetail || "N/A"}<br/>
            <small>${description || ""}</small><br/>
            <small>Start: ${startDateTime || "N/A"}</small><br/>
            <small>Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}</small>
          `;

          marker.bindPopup(popupHtml);
          marker.addTo(markersLayer);

          bounds.push([lat, lng]);
        });

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [40, 40] });
          statusEl.textContent = `Loaded ${bounds.length} units.`;
        } else {
          statusEl.textContent = "No units had valid coordinates.";
        }
      } catch (err) {
        console.error("loadUnits error:", err);
        statusEl.textContent = "Failed to load units:\n" + err.message;
      }
    }

    loadUnits();
    setInterval(loadUnits, 30000);
  </script>
</body>
</html>
